<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± Sistema de Monitoreo Eco ESP32</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a8e6cf 0%, #7fcdcd 50%, #88c999 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 35px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(46, 125, 50, 0.15);
            border: 2px solid rgba(129, 199, 132, 0.3);
        }

        .header h1 {
            color: #2e7d32;
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(46, 125, 50, 0.1);
        }

        .header p {
            color: #388e3c;
            font-size: 1.1rem;
        }

        .status-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-left: 15px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .status-online {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
        }

        .status-offline {
            background: linear-gradient(45deg, #f44336, #ef5350);
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .sensor-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(46, 125, 50, 0.15);
            border: 2px solid rgba(129, 199, 132, 0.3);
        }

        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            font-size: 1.8rem;
            color: #2e7d32;
            font-weight: 700;
        }

        .section-icon {
            font-size: 2.5rem;
            margin-right: 15px;
        }

        .sensor-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .sensor-card {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            border: 2px solid rgba(129, 199, 132, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 45px rgba(46, 125, 50, 0.2);
            border-color: #81c784;
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .sensor-card:hover::before {
            left: 100%;
        }

        .sensor-icon {
            font-size: 2.8rem;
            margin-bottom: 15px;
        }

        .sensor-title {
            font-size: 1.1rem;
            color: #388e3c;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .sensor-value {
            font-size: 2.8rem;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(46, 125, 50, 0.1);
        }

        .sensor-unit {
            font-size: 1.1rem;
            color: #66bb6a;
            font-weight: 500;
        }

        .devices-section {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(46, 125, 50, 0.15);
            border: 2px solid rgba(129, 199, 132, 0.3);
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .device-card {
            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            border: 2px solid rgba(129, 199, 132, 0.4);
            transition: all 0.3s ease;
        }

        .device-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(46, 125, 50, 0.2);
        }

        .device-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .device-name {
            font-size: 1.3rem;
            color: #2e7d32;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .status-on {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .status-off {
            background: linear-gradient(45deg, #757575, #9e9e9e);
            color: white;
            box-shadow: 0 4px 15px rgba(117, 117, 117, 0.3);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 10px 40px rgba(46, 125, 50, 0.15);
            border: 2px solid rgba(129, 199, 132, 0.3);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.8rem;
            color: #2e7d32;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 700;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 10px 40px rgba(46, 125, 50, 0.15);
            border: 2px solid rgba(129, 199, 132, 0.3);
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 15px;
            overflow: hidden;
        }

        .table th,
        .table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(129, 199, 132, 0.2);
        }

        .table th {
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
            font-weight: 600;
            color: #2e7d32;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .table tr:hover {
            background: rgba(129, 199, 132, 0.1);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .loading {
            text-align: center;
            color: #66bb6a;
            font-style: italic;
            padding: 30px;
            font-size: 1.1rem;
        }

        .error {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #e57373;
        }

        .last-update {
            text-align: center;
            color: #388e3c;
            font-size: 1rem;
            margin-top: 25px;
            padding: 15px;
            background: rgba(200, 230, 201, 0.3);
            border-radius: 15px;
            font-weight: 500;
        }

        canvas {
            max-width: 100%;
            height: 400px;
            border-radius: 15px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        #statusText {
            color: #2e7d32;
            margin-left: 10px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .sensor-cards {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .sensor-value {
                font-size: 2.3rem;
            }

            .section-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± Sistema de Monitoreo Eco ESP32</h1>
            <p>Monitoreo inteligente de ambiente y suelo en tiempo real</p>
            <div class="connection-status">
                <span id="connectionStatus" class="status-indicator status-offline"></span>
                <span id="statusText">Conectando...</span>
            </div>
        </div>

        <div class="main-grid">
            <!-- Secci√≥n Ambiental -->
            <div class="sensor-section">
                <div class="section-title">
                    <span class="section-icon">üå§Ô∏è</span>
                    Sensores Ambientales
                </div>
                <div class="sensor-cards">
                    <div class="sensor-card">
                        <div class="sensor-icon">üå°Ô∏è</div>
                        <div class="sensor-title">Temperatura Ambiental</div>
                        <div class="sensor-value" id="temperaturaAmbiental">--</div>
                        <div class="sensor-unit">¬∞C</div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-icon">üí®</div>
                        <div class="sensor-title">Humedad Ambiental</div>
                        <div class="sensor-value" id="humedadAmbiental">--</div>
                        <div class="sensor-unit">%</div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Suelo -->
            <div class="sensor-section">
                <div class="section-title">
                    <span class="section-icon">üå±</span>
                    Sensores de Suelo
                </div>
                <div class="sensor-cards">
                    <div class="sensor-card">
                        <div class="sensor-icon">üèîÔ∏è</div>
                        <div class="sensor-title">Humedad del Suelo</div>
                        <div class="sensor-value" id="humedadSuelo">--</div>
                        <div class="sensor-unit">%</div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-icon">üìä</div>
                        <div class="sensor-title">Valor Raw</div>
                        <div class="sensor-value" id="humedadSueloRaw">--</div>
                        <div class="sensor-unit">ADC</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Dispositivos -->
        <div class="devices-section">
            <div class="section-title">
                <span class="section-icon">‚ö°</span>
                Estado de Dispositivos
            </div>
            <div class="devices-grid">
                <div class="device-card">
                    <div class="device-icon">üíß</div>
                    <div class="device-name">Bomba de Agua</div>
                    <span id="bombaStatus" class="status-badge status-off">Apagada</span>
                </div>
                
                <div class="device-card">
                    <div class="device-icon">üåÄ</div>
                    <div class="device-name">Ventilador</div>
                    <span id="ventiladorStatus" class="status-badge status-off">Apagado</span>
                </div>

                <div class="device-card">
                    <div class="device-icon">üí°</div>
                    <div class="device-name">LED Temperatura</div>
                    <span id="ledStatus" class="status-badge status-off">Apagado</span>
                </div>
            </div>
        </div>

        <!-- Gr√°fico -->
        <div class="chart-container">
            <h3 class="chart-title">üìä Hist√≥rico de Sensores Ambientales y de Suelo</h3>
            <canvas id="dataChart"></canvas>
        </div>

        <!-- Tabla de datos hist√≥ricos -->
        <div class="data-table">
            <h3 class="chart-title">üìã Datos Hist√≥ricos Recientes</h3>
            <div id="loading" class="loading">üå± Cargando datos del sistema...</div>
            <table class="table" id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th>‚è∞ Timestamp</th>
                        <th>üå°Ô∏è Temp. Amb. (¬∞C)</th>
                        <th>üí® Hum. Amb. (%)</th>
                        <th>üèîÔ∏è Hum. Suelo (%)</th>
                        <th>üíß Bomba</th>
                        <th>üåÄ Ventilador</th>
                        <th>üí° LED</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="last-update">
            <p id="lastUpdate">üïê √öltima actualizaci√≥n: --</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB0Q4LgPYL9dZpJztyrx53qvoleqYQkfOk",
            authDomain: "projectsensor-19cfe.firebaseapp.com",
            databaseURL: "https://projectsensor-19cfe-default-rtdb.firebaseio.com",
            projectId: "projectsensor-19cfe",
            storageBucket: "projectsensor-19cfe.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Variables globales
        let chart;
        const maxDataPoints = 25;
        let chartData = {
            labels: [],
            temperatura: [],
            humedadAmbiental: [],
            humedadSuelo: []
        };

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            listenToRealtimeData();
            loadHistoricalData();
        });

        // Inicializar el gr√°fico
        function initChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'üå°Ô∏è Temperatura Ambiental (¬∞C)',
                        data: [],
                        borderColor: '#ff7043',
                        backgroundColor: 'rgba(255, 112, 67, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#ff7043',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }, {
                        label: 'üí® Humedad Ambiental (%)',
                        data: [],
                        borderColor: '#42a5f5',
                        backgroundColor: 'rgba(66, 165, 245, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#42a5f5',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }, {
                        label: 'üèîÔ∏è Humedad del Suelo (%)',
                        data: [],
                        borderColor: '#66bb6a',
                        backgroundColor: 'rgba(102, 187, 106, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#66bb6a',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(129, 199, 132, 0.2)'
                            },
                            ticks: {
                                color: '#2e7d32'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(129, 199, 132, 0.2)'
                            },
                            ticks: {
                                color: '#2e7d32'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#2e7d32',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Escuchar datos en tiempo real
        function listenToRealtimeData() {
            const actualRef = database.ref('/sensores/actual');
            
            actualRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateCurrentData(data);
                    updateConnectionStatus(true);
                } else {
                    updateConnectionStatus(false);
                }
            }, (error) => {
                console.error('Error:', error);
                updateConnectionStatus(false);
            });
        }

        // Actualizar datos actuales
        function updateCurrentData(data) {
            // Actualizar sensores ambientales
            document.getElementById('temperaturaAmbiental').textContent = 
                data.temperatura_ambiental?.toFixed(1) || '--';
            document.getElementById('humedadAmbiental').textContent = 
                data.humedad_ambiental?.toFixed(1) || '--';
            
            // Actualizar sensores de suelo
            document.getElementById('humedadSuelo').textContent = 
                data.humedad_suelo?.toFixed(1) || '--';
            document.getElementById('humedadSueloRaw').textContent = 
                data.humedad_suelo_raw || '--';
            
            // Actualizar estado de la bomba
            const bombaStatus = document.getElementById('bombaStatus');
            if (data.bomba_estado === 'encendida') {
                bombaStatus.textContent = 'Encendida';
                bombaStatus.className = 'status-badge status-on';
            } else {
                bombaStatus.textContent = 'Apagada';
                bombaStatus.className = 'status-badge status-off';
            }
            
            // Actualizar estado del ventilador
            const ventiladorStatus = document.getElementById('ventiladorStatus');
            if (data.ventilador_estado === 'encendido') {
                ventiladorStatus.textContent = 'Encendido';
                ventiladorStatus.className = 'status-badge status-on';
            } else {
                ventiladorStatus.textContent = 'Apagado';
                ventiladorStatus.className = 'status-badge status-off';
            }
            
            // Actualizar estado del LED
            const ledStatus = document.getElementById('ledStatus');
            if (data.led_estado === 'encendido') {
                ledStatus.textContent = 'Encendido';
                ledStatus.className = 'status-badge status-on';
            } else {
                ledStatus.textContent = 'Apagado';
                ledStatus.className = 'status-badge status-off';
            }
            
            // Actualizar timestamp
            document.getElementById('lastUpdate').textContent = 
                `üïê √öltima actualizaci√≥n: ${new Date().toLocaleString()}`;
        }

        // Cargar datos hist√≥ricos
        function loadHistoricalData() {
            const historyRef = database.ref('/sensores/lecturas').orderByKey().limitToLast(50);
            
            historyRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateChart(data);
                    updateTable(data);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dataTable').style.display = 'table';
                }
            });
        }

        // Actualizar gr√°fico
        function updateChart(data) {
            const entries = Object.entries(data).slice(-maxDataPoints);
            
            chart.data.labels = entries.map(([timestamp]) => {
                const date = new Date(parseInt(timestamp));
                return date.toLocaleTimeString();
            });
            
            chart.data.datasets[0].data = entries.map(([, value]) => value.temperatura_ambiental);
            chart.data.datasets[1].data = entries.map(([, value]) => value.humedad_ambiental);
            chart.data.datasets[2].data = entries.map(([, value]) => value.humedad_suelo);
            
            chart.update();
        }

        // Actualizar tabla
        function updateTable(data) {
            const tableBody = document.getElementById('tableBody');
            const entries = Object.entries(data).reverse().slice(0, 15);
            
            tableBody.innerHTML = entries.map(([timestamp, values]) => {
                const date = new Date(parseInt(timestamp));
                return `
                    <tr>
                        <td>${date.toLocaleString()}</td>
                        <td>${values.temperatura_ambiental?.toFixed(1) || '--'}</td>
                        <td>${values.humedad_ambiental?.toFixed(1) || '--'}</td>
                        <td>${values.humedad_suelo?.toFixed(1) || '--'}</td>
                        <td>
                            <span class="status-badge ${values.bomba_estado === 'encendida' ? 'status-on' : 'status-off'}">
                                ${values.bomba_estado || 'N/A'}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${values.ventilador_estado === 'encendido' ? 'status-on' : 'status-off'}">
                                ${values.ventilador_estado || 'N/A'}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${values.led_estado === 'encendido' ? 'status-on' : 'status-off'}">
                                ${values.led_estado || 'N/A'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(isOnline) {
            const indicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                indicator.className = 'status-indicator status-online';
                statusText.textContent = 'Sistema En L√≠nea';
            } else {
                indicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Sistema Desconectado';
            }
        }
    </script>
</body>
</html>
